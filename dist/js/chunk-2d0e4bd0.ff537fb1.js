(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d0e4bd0"],{9201:function(s,r,t){"use strict";t.r(r);var e=function(){var s=this,r=s.$createElement,t=s._self._c||r;return t("div",[t("md")],1)},a=[],n=function(){var s=this,r=s.$createElement;s._self._c;return s._m(0)},l=[function(){var s=this,r=s.$createElement,t=s._self._c||r;return t("section",[t("h3",[s._v("利用 "),t("code",{pre:!0},[s._v("webhook")]),s._v(" 实现持续集成")]),t("ol",[t("li",[s._v("将本地代码上传 "),t("code",{pre:!0},[s._v("GitHub")]),s._v(" 仓库")]),t("li",[s._v("添加 "),t("code",{pre:!0},[s._v("webhook")]),s._v("，配置服务器信息，当仓库中有指定事件发生（比如："),t("code",{pre:!0},[s._v("push")]),s._v("）时，会向指定的服务器发送请求")]),t("li",[s._v("在服务器端运行 "),t("code",{pre:!0},[s._v("node")]),s._v(" 服务，处理 "),t("code",{pre:!0},[s._v("GitHub")]),s._v(" 发过来的请求，然后执行具体的操作")])]),t("h3",[s._v("配置 webhook")]),t("ul",[t("li",[t("p",[s._v("添加 "),t("code",{pre:!0},[s._v("webhook")]),t("img",{staticStyle:{width:"100%"},attrs:{src:"https://relearnvue.com/static/webhook1.png"}})])]),t("li",[t("p",[s._v("配置服务器信息 "),t("img",{staticStyle:{width:"100%"},attrs:{src:"https://relearnvue.com/static/webhook2.png"}})])])]),t("h3",[s._v("编写后台服务")]),t("ul",[t("li",[t("code",{pre:!0},[s._v("webhooks.js")])])]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" http = "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'http'")]),s._v(")\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" createHandler = "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'github-webhook-handler'")]),s._v(")\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 这里的path和secret要和github上保持一致")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" handler = createHandler({ "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("path")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'/webhooks'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("secret")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'relearnvuehahaha'")]),s._v(" })\n\nhttp\n  .createServer("),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("req, res")]),s._v(") ")]),s._v("{\n    handler(req, res, "),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("err")]),s._v(") ")]),s._v("{\n      res.statusCode = "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("404")]),s._v("\n      res.end("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'no such location'")]),s._v(")\n    })\n  })\n  .listen("),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("6519")]),s._v(", () => {\n    "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Webhooks Listen at 6519'")]),s._v(")\n  })\n\nhandler.on("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'error'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("err")]),s._v(") ")]),s._v("{\n  "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".error("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Error：'")]),s._v(", err.message)\n})\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 监听push事件")]),s._v("\nhandler.on("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'push'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("event")]),s._v(") ")]),s._v("{\n  "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log(\n    "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'接收到一个push事件，for %s to %s：'")]),s._v(",\n    event.payload.repository.name,\n    event.payload.ref\n  )\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 只处理master分支上且commit message以[cicd]开头的push事件")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" (\n    event.payload.ref === "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'refs/heads/master'")]),s._v(" &&\n    event.payload.head_commit.message.startsWith("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'[cicd]'")]),s._v(")\n  ) {\n    "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'deploy master branch'")]),s._v(")\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 执行命令")]),s._v("\n    run_cmd("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'sh'")]),s._v(", ["),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'./deploy-dev.sh'")]),s._v("], text => "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log(text))\n  }\n})\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 使用child_process执行shell文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title"}},[s._v("run_cmd")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("cmd, args, cb")]),s._v(") ")]),s._v("{\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" spawn = "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'child_process'")]),s._v(").spawn\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" child = spawn(cmd, args)\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("let")]),s._v(" res = "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("''")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 输出")]),s._v("\n  child.stdout.on("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'data'")]),s._v(", buffer => (res += buffer.toString()))\n  child.stdout.on("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'end'")]),s._v(", () => cb(res))\n}\n")])]),t("ul",[t("li",[t("p",[s._v("将 "),t("code",{pre:!0},[s._v("webhooks.js")]),s._v(" 运行在服务器端，调试时可以用 "),t("code",{pre:!0},[s._v("node")]),s._v("、"),t("code",{pre:!0},[s._v("nodemon")]),s._v("，也可以用 "),t("code",{pre:!0},[s._v("forever")]),s._v("、"),t("code",{pre:!0},[s._v("pm2")]),s._v(" 保持后台运行")])]),t("li",[t("p",[t("code",{pre:!0},[s._v("deploy-dev.sh")])]),t("ul",[t("li",[s._v("拉取最新代码")]),t("li",[s._v("执行"),t("code",{pre:!0},[s._v("build")])])])])]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v("echo 正在部署...\necho git pull...\ngit pull origin master\nnpm run build\n")])])])}],p=t("2877"),v={},_=Object(p["a"])(v,n,l,!1,null,null,null),c=_.exports,o={components:{md:c}},h=o,i=Object(p["a"])(h,e,a,!1,null,"479e38c8",null);r["default"]=i.exports}}]);
//# sourceMappingURL=chunk-2d0e4bd0.ff537fb1.js.map